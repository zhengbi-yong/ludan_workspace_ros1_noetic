<launch>
    <!-- 硬件接口参数 -->
    <arg name="ns" default="motor_hw_interface" />
    <arg name="port" default="/dev/ttyACM0" />
    <arg name="baud" default="921600" />
    <arg name="tf_prefix" default="" />
    <arg name="loop_hz" default="500" />
    <arg name="controller_config" default="$(find damiao_motor_driver)/cfg/moveit_controllers.yaml" />

    <!-- 关节映射配置（可选） -->
    <arg name="joint_mapping" default="" />
    
    <!-- 启动硬件接口节点 -->
    <group ns="$(arg ns)">
        <!-- 在节点外部加载控制器配置到参数服务器，这样 controller_spawner 才能找到 -->
        <rosparam command="load" file="$(arg controller_config)" />
        
        <!-- 如果提供了关节映射文件，则加载它 -->
        <rosparam if="$(eval joint_mapping != '')" command="load" file="$(arg joint_mapping)" />
        
        <node pkg="damiao_motor_driver"
              type="motor_hw_interface_node"
              name="motor_hw_interface"
              output="screen">
            <param name="port" value="$(arg port)" />
            <param name="baud" value="$(arg baud)" />
            <param name="tf_prefix" value="$(arg tf_prefix)" />
            <param name="loop_hz" value="$(arg loop_hz)" />
            
            <!-- 启用直接发布 joint_states（备用方案，当 joint_state_controller 未启动时使用） -->
            <param name="publish_joint_states_directly" value="true" />
            <param name="joint_state_publish_rate" value="200" />
            
            <!-- 将关节映射加载到节点的私有命名空间 (~joints) -->
            <rosparam if="$(eval joint_mapping != '')" command="load" file="$(arg joint_mapping)" />
        </node>

        <!-- 等待 controller_manager 服务可用后再启动 spawner -->
        <!-- 启动控制器管理器，加载并启动 joint_state_controller -->
        <!-- 注意：这里只启动 joint_state_controller，具体的轨迹控制器由 MoveIt 管理 -->
        <!-- 增加延迟确保硬件接口完全初始化，并增加超时时间 -->
        <node pkg="controller_manager" 
              type="spawner" 
              name="controller_spawner" 
              output="screen"
              launch-prefix="bash -c 'sleep 5; $0 $@'"
              args="--timeout 20 joint_state_controller" />
    </group>

    <!-- 将 /motor_hw_interface/joint_states 重映射到 /joint_states，让 MoveIt 能够接收 -->
    <!-- 注意：如果硬件接口直接发布 joint_states，则不需要 relay -->
    <node pkg="topic_tools" 
          type="relay" 
          name="joint_states_relay"
          output="screen"
          args="/motor_hw_interface/joint_states /joint_states" />

    <!-- 发布 robot_state_publisher，将 joint_states 转换为 TF -->
    <node pkg="robot_state_publisher" 
          type="robot_state_publisher" 
          name="robot_state_publisher"
          output="screen">
        <remap from="joint_states" to="/joint_states" />
    </node>

    <!-- 注意：MoveIt 会通过 ros_control 接口自动加载和切换轨迹控制器 -->
    <!-- 确保 MoveIt 配置中的 controller_manager_ns 指向 motor_hw_interface -->
</launch>

